\documentclass[uplatex,dvipdfmx]{ujarticle}
\input{mylib.tex}
\usepackage{tikz}
\usetikzlibrary{positioning} % これを必ず追加
\begin{document}

\title{ESP32+FluidNC+Raspberry Pi 4B+CNCjs セットアップ草案}
\author{草案者: Wood Burned}
\date{\today}
\maketitle



\section{概念設計図}

本章では、Raspberry Pi 4B上でCNCjsを動作させ、USB経由でESP32(FluidNC)を直接制御する構成の全体像を示す。高校卒業直後の初学者を想定し、Linuxやモーション制御の基礎から説明する。

\subsection{全体構成}

Raspberry Pi 4B上でCNCjsを起動し、USB接続されたESP32(FluidNC)に対しG-codeを送信する。ESP32はモーター制御信号(STEP/DIR/EN)をステッピングドライバへ出力し、ドライバはステッピングモーターを駆動する。

\begin{figure}[h]
\centering
\begin{tikzpicture}[
  font=\small,
  node distance=23mm,
  box/.style={draw, minimum width=20mm, minimum height=12mm, align=center, rounded corners=2pt}
]
\node[box] (raspi) {Raspberry Pi 4B\\CNCjs};
\node[box, right=of raspi] (esp32) {ESP32\\FluidNC};
\node[box, right=of esp32] (driver) {ステッピング\\ドライバ};
\node[box, right=of driver] (motor) {ステッピング\\モーター};

\draw[->] (raspi) -- node[above]{USB} (esp32);
\draw[->] (esp32) -- node[above]{STEP DIR EN} (driver);
\draw[->] (driver) -- node[above]{回転駆動} (motor);
\end{tikzpicture}
\caption{Raspberry Pi 直結の最小構成}
\end{figure}

\subsection{必要構成要素}
\begin{itemize}
    \item Raspberry Pi 4B本体（CNCjs動作用）
    \item ESP32ボード（FluidNCファームウェア書き込み済み）
    \item ステッピングドライバ（TB6600など､3A4線バイポーラ出力に対応したもの）
    \item ステッピングモーター（NEMA17/23など）
    \item 電源（モーター駆動用 24V系、Raspberry Pi/ESP32用 5V系）
    \item USBケーブル（Raspberry PiとESP32の接続用）
\end{itemize}

\subsection{信号と電力の流れ}
\begin{itemize}
    \item 信号経路: Raspberry Pi (CNCjs) $\to$ ESP32 (FluidNC) $\to$ ステッピングドライバ $\to$ モーター
    \item 電力経路: 24V系(モーター/ドライバ駆動), 5V系(Raspberry Pi/ESP32駆動)
\end{itemize}

\subsection{ソフトウェア構成}
\begin{itemize}
    \item Raspberry Pi OS:Raspberry PiのOS(Operating Software)｡Mac OSの遠い親戚｡
    \item CNCjs: ブラウザベースのCNC操作UI。Raspberry Pi上で動作。
    \item FluidNC: ESP32上で動作するCNC制御ファームウェア。G-codeを解釈しモーション制御信号を生成。
\end{itemize}

\subsection{用語集}
\begin{description}
    \item[G-code] CNC機械を制御するための標準命令セット。例: G0/G1は直線移動､などの規則がある。
    \item[ステッピングモーター] 一定角度ごとに回転するモーター。精密位置決めに用いる。
    \item[STEP/DIR/EN] ドライバに送る基本制御信号。STEPはパルス数で移動量、DIRは方向、ENは有効化。
    \item[ステップ] ステッピングモーターが動作する最小単位｡
    \item[ホーミング] 原点位置を決定する動作。現状省略。
    \item[Linux] オープンソースのある条件を満たすOSの総称。Raspberry Pi OSもLinux系。
    \item[CLI(Command Line Interface)] 文字入力でコンピュータを操作する方式。ターミナルやシェルで実行。｢コマンドプロンプト｣だと思って良い｡
    \item[シェル] CLIの実行環境。bashやzshなど。
    \item[USBシリアル通信] USB経由でシリアルデータを送受信する方式。ESP32との接続に用いる。
\end{description}

\subsection{最低限調べておいてほしいこと}

本構成を安全かつ効率的に理解し運用するため、以下の基礎事項は事前に調べておくことを推奨する。いずれも高度な専門書を読む必要はないが、概要と主要用語を把握しておくべきである。

\begin{description}
  \item[Linuxとは何か]  
    オープンソースのUNIX系オペレーティングシステムであり、Raspberry Pi OSもこれに属する。ファイルシステムの階層構造、ユーザーと権限の概念、パッケージマネージャ(例: \texttt{apt})、コマンドライン操作(CLI)などの基本を理解しておくこと。
  
  \item[Raspberry Piとは何か]  
    ARM系プロセッサを搭載した小型シングルボードコンピュータであり、低消費電力でLinuxを動作させられる。本構成ではCNCjsのホストとして使用する。GPIO端子やUSBポートなどの基本的なハード構造も確認しておくこと。

  \item[高校電磁気の復習]  
    直流回路のオームの法則($V=IR$)、抵抗・コイル・コンデンサの基本特性、電力計算($P=VI$)、直列/並列接続の違い、電流と磁界の関係、誘導起電力の概念など。ステッピングモーターやドライバの動作理解に不可欠である。

  \item[ステッピングモーターとは何か]  
    電気パルスの入力に応じて一定角度ずつ回転するモーター。1回転あたりのステップ数、マイクロステップ制御、保持トルク、脱調の概念を把握すること。STEP/DIR信号と回転方向・回転量の関係も確認する。
  
    \item[CNCによる死亡事故例やヒヤリハット]  
    CNC装置は強力な駆動系を持ち、加工対象や工具が高速で移動するため、不適切な操作や安全管理不足により死亡事故や重大な負傷が発生している。過去には回転工具への巻き込まれ、破損工具の飛散、固定不良材料の射出、制御系誤動作による衝突などが報告されている。実際の事故事例やヒヤリハット事例を調べ、危険要因とその防止策を理解しておくこと。非常停止(E-Stop)や安全カバーの有効性についても確認する。


\end{description}

\subsection{安全留意事項}
\begin{itemize}
    \item モーター動作中は手や物を可動部に近づけない。
    \item 電源投入前に配線の正誤と固定状態を確認する。
    \item 電源系は系統ごとにヒューズを設ける。
    \item 手袋をつけてNCを稼働させない｡
\end{itemize}

\section{セットアップ編}

\subsection{ESP32ボードの準備とファーム書き込み}

CNC用モーションコントローラとしてESP32を用いる。ファームウェアはFluidNCを採用する。初期導入はPC上のGoogle ChromeからFluidNC公式のオンラインインストーラを用いる。Web Serial APIを使うためChromeを前提とする。

手順の概観は次の通り。
\begin{enumerate}
\item ESP32をUSBでPCに接続する（給電はPC側/基板側の二冗長系で行う）。
\item Google ChromeでFluidNC Web Installerを開き、Connectで該当シリアルポートを選択する。
\item InstallからLatestビルド（Wi-Fi有効版）を選択して書き込む。\footnote{運用ではWi-Fiは使わない。導入や更新時のみ使う方針とする。}
\item 書き込み完了後、\textbf{インストーラの「Config」（または「Files」）欄}から \texttt{config.yaml} を新規作成する。基本パラメータは後で対話的に調整する（手入力でYAMLを記入せず、インストーラ側で編集・保存する）。
\end{enumerate}

注意点として、各軸のSTEP/DIR/ENのピン割付は、ESP32で\textbf{出力に使ってよいGPIO}を選ぶ。ブートストラップ用のストラッピングピン（GPIO0, 2, 5, 12, 15）やフラッシュ接続ピン（GPIO6〜11）、入力専用ピン（GPIO34〜39）は避ける。UARTのTX/RX（GPIO1/3）も原則避ける。割付は後述の設定方針と合わせて決定する。ピン番号は必ず最新の情報を確認すること｡


\newpage

\subsection{FluidNCの基本設定（Config欄で行う方針）}

本書の\textbf{基本パラメータを信用せず}、FluidNC Web Installerの\textbf{Config欄から対話的に調整}する。理由は、機械固有の要素（スクリューピッチ、マイクロステップ、剛性、負荷、ドライバ仕様）が初期値を大きく左右するためである。次の考え方で進める。

\subsubsection*{設定の流れ（対話的チューニング）}
\begin{enumerate}
\item 軸とモータの論理構成を定義する（X/Y/Z、スレーブ軸の有無など）。
\item 各軸の\textbf{ピン割付}を決める。前節の\textbf{使用可能GPIOの制約}を満たす組合せを選ぶ。
\item \textbf{steps\_per\_mm}(例:320steps/mm)は実測で校正する。適当な手段での測長を繰り返し、誤差を詰める。
\item \textbf{max\_rate}と\textbf{acceleration}は安全側から立ち上げ、脱調・共振・発熱を観察しつつ段階的に上げる。
\item 方向反転やリミット/プローブ極性は、実機の挙動に合わせて修正する。
\end{enumerate}

\noindent 補足: Config欄はWeb UIでの保存を前提とする。エディタでのテキスト貼付は避ける。

\subsection{Raspberry Pi 4BへのCNCjs導入（デスクトップ版OS + 公式Dockerfile）}

CNCjsはWebベースのG-code送受信/UIであり、Raspberry Pi 4Bで常用する。OSは\textbf{Raspberry Pi OS（64-bit, Desktop版）}を用いる。導入時のみWi-Fiを有効化し、\textbf{運用は有線（USB/有線LAN）}とする。「電プチ」（突然の電源断）対策として Overlay File System を有効化する運用を推奨する。

\subsubsection*{OSインストール（Raspberry Pi Imager）}
\begin{enumerate}
\item PCでRaspberry Pi Imagerを起動し、OSは\textbf{Raspberry Pi OS (64-bit) with desktop}を選ぶ。
\item Advanced Settings（歯車）で、ホスト名／ロケール、\textbf{SSH有効化}、\textbf{Wi-Fi設定（導入時のみ使用）}など好みの設定を事前指定して書き込む。
\item 初回起動後、必要なパッケージを更新する。
\end{enumerate}

\begin{lstlisting}[caption=初期パッケージ導入（APT）, label=code:apt-init, language=bash]
# Raspberry Pi OSの更新
sudo apt update
sudo apt -y full-upgrade

# 導入に使うツール群
sudo apt -y install git curl build-essential 

#Dockerのインストール､公式HPを参照
curl -sSL https://get.docker.com | sh
sudo docker ps

#再起動
sudo reboot now
\end{lstlisting}

\subsubsection*{電プチ対策（Overlay File System）}
Raspberry Pi OSは\texttt{raspi-config}から\textbf{Overlay File System}を有効化できる。運用中はrootfsを実質Read-Only化し、変更はRAM上に乗る。設定変更や更新時は一時的に無効化して再起動する運用にする。

\begin{lstlisting}[caption=OverlayFSの有効化（対話/非対話の例）, label=code:overlay, language=bash]
対話（raspi-config）

sudo raspi-config # Performance Options -> Overlay File System -> Enable
非対話（新しめのraspi-configで有効）

sudo raspi-config nonint enable_overlayfs
sudo reboot
\end{lstlisting}

\subsubsection*{CNCjsの導入（公式Dockerfileを用いる）}

公式リポジトリのDockerfileを用いて\textbf{Dockerイメージをローカルビルド}し、コンテナとして常駐運用する。公式Dockerfileは\texttt{dist/cncjs}の成果物を前提とするため、\textbf{先にNode/Yarnでビルドする}。

\paragraph{1) CNCjsのビルド（dist生成）} 
このように行う｡
\begin{lstlisting}[caption=Node/Yarnでフロントをビルド（Pi上で可）, label=code:build-dist, language=bash]
Node 18系を前提（bookworm既定のnodejsで可。必要ならNodeSource等を使用）

sudo apt -y install nodejs npm
sudo npm -g install yarn

git clone https://github.com/cncjs/cncjs.git
cd cncjs
yarn install
yarn run build # dist/cncjs が生成される
\end{lstlisting}
\newpage
\paragraph{2) 公式Dockerfileでイメージ化}
このように行う｡
\begin{lstlisting}[caption=Dockerビルドと起動, label=code:docker-run, language=bash]
リポジトリ直下にある公式Dockerfileを使用

docker build -t cncjs:local -f Dockerfile .
デフォルトExposeは 8000。ホスト8080に割り当てる例。
/dev/ttyUSB* (or /dev/ttyACM*) をコンテナへ渡す

docker run -d --name cncjs
--restart=unless-stopped
--device /dev/ttyUSB0
-p 8080:8000 cncjs:local
\end{lstlisting}

\paragraph{3) 起動・アクセス・運用方針}
\begin{itemize}
\item ブラウザから \texttt{http://<raspi-ip>:8080/} にアクセスし、CNCjs UIを操作する。ブラウザはGoogle Chromeを推奨する。
\item ESP32はUSB直結し、CNCjsのポート選択で \texttt{/dev/ttyUSB*} または \texttt{/dev/ttyACM*} を選ぶ。
\item 運用は有線前提、Wi-Fiは基本無効化（導入・更新時のみ有効）。
\end{itemize}

\begin{lstlisting}[caption=systemdで自動起動（コンテナを常駐させる例）, label=code:systemd, language=bash]
/etc/systemd/system/cncjs.service

[Unit]
Description=CNCjs container
After=network-online.target docker.service
Wants=docker.service

[Service]
Restart=always
ExecStart=/usr/bin/docker start -a cncjs
ExecStop=/usr/bin/docker stop cncjs

[Install]
WantedBy=multi-user.target
有効化

sudo systemctl daemon-reload
sudo systemctl enable --now cncjs
\end{lstlisting}

\subsection{この草案の要点（実施順）}
\begin{enumerate}
\item Google ChromeでFluidNC Web Installerを使い、ESP32へ書き込み後、\textbf{インストーラのConfig欄}から \texttt{config.yaml} を作って編集する（配布YAMLは用いない）。
\item 各軸のピン割付はESP32のGPIO制約を満たす組合せにする（ストラッピング・フラッシュ・入力専用ピンは避ける）。
\item Raspberry Pi OSは\textbf{デスクトップ版}をRaspberry Pi Imagerで導入。導入時のみWi-Fi有効、以後は無効化。電プチ対策でOverlayFSを有効化。
\item CNCjsは\textbf{公式Dockerfile}でローカルビルドし、コンテナ運用する（デフォルトExposeは8000、例では8080へ割当）。
\end{enumerate}

\begin{thebibliography}{999}
\bibitem{fluidnc-installer} FluidNC Web Installer（公式）.
\bibitem{fluidnc-config} FluidNC Config file Overview（公式Wiki）.
\bibitem{fluidnc-motion} FluidNC Motion Setup（公式Wiki）.
\bibitem{espressif-gpio} Espressif ESP-IDF: GPIO \& RTC GPIO（公式）.
\bibitem{espressif-datasheet} Espressif ESP32 Series Datasheet（公式）.
\bibitem{rpi-imager-wifi} Raspberry Pi Documentation: Wi-Fi/Imager Advanced Settings（公式）.
\bibitem{rpi-overlay-wp} Raspberry Pi Whitepaper: Making a more resilient file system（公式）.
\bibitem{cncjs-install} CNCjs Installation / Raspberry Pi Setup Guide（公式）.
\bibitem{cncjs-dockerfile} CNCjs 公式Dockerfile（master）.
\bibitem{dockerhub} Docker Hub: cncjs/cncjs（公式イメージ）.
\end{thebibliography}

\end{document}